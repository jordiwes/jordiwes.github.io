<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friends Map</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .header {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .header h1 {
            font-size: 24px;
            color: #333;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001;
        }

        .error {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #f44336;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001;
            max-width: 500px;
        }

        .custom-marker {
            background-color: #4285f4;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: 500;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Friends Around the World</h1>
    </div>

    <div id="loading" class="loading">Loading map...</div>
    <div id="map"></div>

    <script>
        // Configuration
        const CONFIG = {
            // Replace with your Google Maps API Key
            MAPS_API_KEY: 'AIzaSyDkd7caiNOjXztCl8ZFY-HoeI7MfJJUI7Y',

            // Replace with your Google Sheets CSV export URL
            // To get this: File > Share > Publish to web > Choose CSV format
            // Expected columns: Name, Latitude, Longitude
            SHEET_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTfr2OCoaWIAzqmYxMM4nqf1D5DiP0rCZsM7VX059YEwAxHvSrFZsys7fZ1UkXJT0d6o8QPm1jul0Af/pub?output=csv'
        };

        let map;
        let markers = [];

        // Initialize map
        function initMap() {
            // Center map on world view
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 2,
                center: { lat: 20, lng: 0 },
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });

            // Load friend locations
            loadFriendLocations();
        }

        // Parse CSV data
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());

            return lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim());
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index];
                });
                return obj;
            });
        }

        // Load friend locations from Google Sheets
        async function loadFriendLocations() {
            let csvText;

            try {
                console.log('Fetching from Google Sheets:', CONFIG.SHEET_URL);
                const response = await fetch(CONFIG.SHEET_URL, {
                    mode: 'cors',
                    redirect: 'follow'
                });

                console.log('Response status:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`Failed to fetch data: ${response.status} ${response.statusText}`);
                }

                csvText = await response.text();
                console.log('Successfully fetched CSV data');
            } catch (fetchError) {
                console.error('Error fetching from Google Sheets:', fetchError);
                console.log('Falling back to local sample-data.csv');

                // Try to load local CSV as fallback
                try {
                    const localResponse = await fetch('sample-data.csv');
                    if (localResponse.ok) {
                        csvText = await localResponse.text();
                        showError('Using local data file (Google Sheets unavailable)');
                    } else {
                        throw fetchError; // Re-throw original error
                    }
                } catch (localError) {
                    throw new Error(`Failed to load data from both Google Sheets and local file: ${fetchError.message}`);
                }
            }

            try {
                const friends = parseCSV(csvText);

                // Clear existing markers
                markers.forEach(marker => marker.setMap(null));
                markers = [];

                // Create bounds to fit all markers
                const bounds = new google.maps.LatLngBounds();

                // Add markers for each friend
                friends.forEach(friend => {
                    const lat = parseFloat(friend.Latitude);
                    const lng = parseFloat(friend.Longitude);
                    const name = friend.Name;

                    if (isNaN(lat) || isNaN(lng) || !name) {
                        console.warn('Invalid friend data:', friend);
                        return;
                    }

                    const position = { lat, lng };

                    // Create marker
                    const marker = new google.maps.Marker({
                        position: position,
                        map: map,
                        title: name,
                        animation: google.maps.Animation.DROP
                    });

                    // Create info window
                    const infoWindow = new google.maps.InfoWindow({
                        content: `<div style="padding: 10px; font-size: 16px; font-weight: 500;">${name}</div>`
                    });

                    // Show info window on click
                    marker.addListener('click', () => {
                        // Close all other info windows
                        markers.forEach(m => {
                            if (m.infoWindow) {
                                m.infoWindow.close();
                            }
                        });
                        infoWindow.open(map, marker);
                    });

                    marker.infoWindow = infoWindow;
                    markers.push(marker);
                    bounds.extend(position);
                });

                // Fit map to show all markers
                if (markers.length > 0) {
                    map.fitBounds(bounds);

                    // Don't zoom in too much if there's only one marker
                    if (markers.length === 1) {
                        map.setZoom(10);
                    }
                }

                document.getElementById('loading').style.display = 'none';

            } catch (error) {
                console.error('Error loading friend locations:', error);
                document.getElementById('loading').style.display = 'none';
                showError('Error loading friend locations. Please check your Google Sheets URL and configuration.');
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);

            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Check if configuration is set
        if (CONFIG.MAPS_API_KEY === 'YOUR_GOOGLE_MAPS_API_KEY') {
            document.getElementById('loading').innerHTML =
                '<strong>Setup Required</strong><br>Please add your Google Maps API key in index.html';
        }
    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDkd7caiNOjXztCl8ZFY-HoeI7MfJJUI7Y&callback=initMap">
    </script>
</body>
</html>
